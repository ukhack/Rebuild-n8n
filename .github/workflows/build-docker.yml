name: Fix n8n and build docker

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      ref:
        description: '拉取标签，格式: owner/repo@tag，例如: n8n-io/n8n@2.1.1'
        required: false
        default: ''

jobs:
  apply-patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 获取最新 n8n 版本
        id: latest-version
        run: |
          pip install requests packaging
          python scripts/get_latest_n8n_release.py

      - name: 输出最新版本
        run: |
          echo "最新 n8n 版本: ${{ steps.latest-version.outputs.LATEST_TAG }}"

      - name: 解析仓库和标签
        id: parse-ref
        if: inputs.ref != ''
        run: |
          REFS="${{ inputs.ref }}"
          
          if [[ "$REFS" == *"@"* ]]; then
            REPO_PART=$(echo "$REFS" | cut -d'@' -f1)
            TAG="${{ inputs.ref }}"  # 完整标签，包括前缀
            
            if [[ "$REPO_PART" == *"/"* ]]; then
              REPO="$REPO_PART"
            else
              REPO="n8n-io/$REPO_PART"
            fi
            
            echo "repository=$REPO" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "解析结果: 仓库=$REPO, 标签=$TAG"
          else
            echo "格式错误，请使用 仓库名@标签 格式"
            exit 1
          fi

      - name: 拉取目标仓库
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.ref != '' && steps.parse-ref.outputs.repository || 'n8n-io/n8n' }}
          ref: ${{ inputs.ref != '' && steps.parse-ref.outputs.tag || steps.latest-version.outputs.LATEST_TAG }}
          fetch-depth: 1

      - name: 拉取locales和patches
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: source-repo
          sparse-checkout: |
            locales
            patches
          sparse-checkout-cone-mode: false

      - name: 复制locales文件
        run: |
          mkdir -p packages/frontend/@n8n/i18n/src/locales
          cp -r source-repo/locales/* packages/frontend/@n8n/i18n/src/locales/

      - name: 应用patch
        run: |
          for patch in source-repo/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying: $patch"
              git apply "$patch"
            fi
          done

      - name: 读取package.json
        id: package
        run: |
          NODE_VERSION=$(grep -o '"node": "[^"]*"' package.json | cut -d'"' -f4 | sed 's/>=//')
          PNPM_VERSION=$(grep -o '"pnpm": "[^"]*"' package.json | cut -d'"' -f4 | sed 's/>=//')
          IMAGE_TAG=$(grep -o '"version": "[^"]*"' package.json | cut -d'"' -f4)
          echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT
          echo "pnpm_version=$PNPM_VERSION" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Node version: $NODE_VERSION"
          echo "Pnpm version: $PNPM_VERSION"
          echo "Image tag: $IMAGE_TAG"

      - name: 安装Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.package.outputs.node_version }}

      - name: 安装pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ steps.package.outputs.pnpm_version }}

      - name: 设置Docker BuildX
        uses: docker/setup-buildx-action@v3

      - name: 获取小写用户名
        id: lowercase
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner=$OWNER_LOWER" >> $GITHUB_OUTPUT

      - name: 登录GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
      
      - name: 安装依赖
        run: |
          pnpm install -w
          pnpm add zx path -w

      - name: 验证依赖
        run: |
          ls -la node_modules/zx/ 2>/dev/null && echo "zx 已安装" || echo "zx 未安装"

      - name: 预编译
        run: |
          node scripts/build-n8n.mjs

      - name: 构建并推送n8n镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/images/n8n/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/${{ steps.lowercase.outputs.owner }}/n8n:${{ steps.package.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: 构建并推送runners镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/images/runners/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/${{ steps.lowercase.outputs.owner }}/runners:${{ steps.package.outputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: 结束
        run: |
          echo "成功。"
