# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Translate n8n

on:
  schedule:
  - cron: "0 5 * * *"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag to use (must start with "n8n@", e.g. n8n@1.2.3). If empty, workflow will fetch latest release from n8n-io/n8n.'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        node-version: [22.x]
    steps:
    
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        path: ./temp-get-latest

    - name: 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: 获取最新 n8n 版本
      id: latest-version
      run: |
        pip install requests packaging
        python temp-get-latest/scripts/get_latest_n8n_release.py

    - name: 输出最新版本
      run: |
        echo "最新 n8n 版本: ${{ steps.latest-version.outputs.LATEST_TAG }}"

    
    - name: Determine release tag
      id: latest_release
      run: |
        # Read input tag (may be empty)
        INPUT_TAG="${{ github.event.inputs.tag }}"
        # Trim whitespace
        INPUT_TAG="$(echo -n "$INPUT_TAG" | tr -d '[:space:]')"

        if [ -n "$INPUT_TAG" ]; then
          # Validate that provided tag starts with n8n@
          if [[ "$INPUT_TAG" != n8n@* ]]; then
            echo "Error: Provided tag '$INPUT_TAG' must start with 'n8n@' (e.g. n8n@1.2.3)."
            exit 1
          fi
          LATEST_VERSION="$INPUT_TAG"
        else
          # No input tag provided — fetch latest release from upstream
          LATEST_VERSION=${{ steps.latest-version.outputs.LATEST_TAG }}
        fi

        echo "Using release tag: $LATEST_VERSION"
        echo "REF_TAG=$LATEST_VERSION" >> $GITHUB_OUTPUT

    - name: Setup corepack and pnpm
      run: |
        npm i -g corepack@0.31
        corepack enable

    - name: Checkout local
      uses: actions/checkout@v4
      with:
        path: ./n8n-i18n-chinese

    - name: Check if tag exists
      id: check_tag
      run: |
        TAG="${{ steps.latest-version.outputs.LATEST_TAG }}"
        echo "Checking for remote tag: $TAG"
        if git ls-remote --tags origin | grep "refs/tags/$TAG$"; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
      working-directory: /home/runner/work/Rebuild-n8n/Rebuild-n8n/n8n-i18n-chinese

    - name: Exit if tags exist
      if: steps.check_tag.outputs.exists == 'true'
      run: |
        echo "Tags exist, stopping workflow."

    - name: Translate New Strings
      if: steps.check_tag.outputs.exists == 'false'
      run: pnpm install && node translate.js
      working-directory: /home/runner/work/Rebuild-n8n/Rebuild-n8n/n8n-i18n-chinese/scripts
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_API_BASE: ${{ vars.OPENAI_API_BASE }}
        OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
        OPENAI_API_CONCURRENT: ${{ vars.OPENAI_API_CONCURRENT }}
        REF_TAG: ${{ steps.latest-version.outputs.REF_TAG }}

    - name: Translate Publish Git
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        
        git add locales/* scripts/temp/en.json || true
        
        # 如果没有变更就跳过
        if git diff --cached --quiet; then
          echo "No changes to commit."
        else
          git commit -m "chore: auto translate"
          git push origin
        fi
      working-directory: /home/runner/work/Rebuild-n8n/Rebuild-n8n/n8n-i18n-chinese

    - name: 创建 git tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        TAG="${{ steps.latest-version.outputs.LATEST_TAG }}"
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"
        
        if git diff --cached --quiet; then
          echo "没有更改，跳过提交"
        else
          git commit -m "chore: add translate for ${{ steps.latest-version.outputs.LATEST_TAG }}"
          git tag $TAG
          git push origin $TAG
        fi
        
      working-directory: /home/runner/work/Rebuild-n8n/Rebuild-n8n/n8n-i18n-chinese

    - name: 创建 GitHub Release
      if: steps.check_tag.outputs.exists == 'false'
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.latest-version.outputs.LATEST_TAG }}
        name: Release translation to ${{ steps.latest-version.outputs.LATEST_TAG }}
        body: |
          自动发布的中文语言包版本。
        files: |
            n8n-i18n-chinese/locales/zh.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GHCR_TOKEN }}
